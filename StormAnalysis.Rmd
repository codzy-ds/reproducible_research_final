---
title: "Storm Analysis"
author: "Michel Bernier"
date: "October 10, 2017"
output: html_document
---

## Introduction
This document will analyse the storm event database from the National weather services. This analysis will try to answer two question : 

1- Which types of events, inside the united states are the most harmful with respect to population health.
2- Inside the United States, which types of events have the geatest economic consequences.

## Data Processing

First Download and read the dataset.
```{r echo=TRUE, cache=TRUE}
if(!dir.exists("data")) {
  dir.create("data")
  download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", "data/dataset.csv.bz2")
}
data <- read.csv2("data/dataset.csv.bz2", sep = ",")
```

Since not all year have enough data to be significant, we will eliminate the rows that have under the mean per year. (Normally would not be significant, but good enough for the dataset).
```{r echo=TRUE}
library(dplyr)

data$year <- as.numeric(format(as.Date(data$BGN_DATE, format = "%m/%d/%Y %H:%M:%S"), "%Y"))

findBreakingPoint <- data[c("year")]
findBreakingPoint <- findBreakingPoint %>%
  group_by(year) %>%
  summarise(count = n())

minyear <- min(findBreakingPoint[findBreakingPoint$count > mean(findBreakingPoint$count),]$year)

data <- subset(data, minyear <= year)

```

### 2- Economic consequences
Than filter by variables and transform quantity of damage in dollars with the indice (k,m,b).
```{r echo=TRUE}
finvars <- names(data) %in% c("year", "EVTYPE", "PROPDMG", "PROPDMGEXP", "CROPDMG", "CROPDMGEXP")
financial_data <- data[finvars]
financial_data$CROPDMG <- as.numeric(as.character(financial_data$CROPDMG))
financial_data$PROPDMG <- as.numeric(as.character(financial_data$PROPDMG))
financial_data <- transform(financial_data, PROPDMG = ifelse(tolower(PROPDMGEXP) == "k", PROPDMG * 1e3, 
                                                             ifelse(tolower(PROPDMGEXP) == "m", PROPDMG * 1e6, 
                                                                    ifelse(tolower(PROPDMGEXP) == "b", PROPDMG * 1e9, PROPDMG))))
financial_data <- transform(financial_data, CROPDMG = ifelse(tolower(CROPDMGEXP) == "k", CROPDMG * 1e3, 
                                                             ifelse(tolower(CROPDMGEXP) == "m", CROPDMG * 1e6, 
                                                                    ifelse(tolower(CROPDMGEXP) == "b", CROPDMG * 1e9, CROPDMG))))

```

Filter sum the data per event type and year. and get the 6 events that have the most economic consequence.
```{r echo=TRUE}
financial_data <- financial_data %>%
  group_by(year, EVTYPE) %>%
  summarise(totalcropdmg=sum(CROPDMG), totalpropdmg=sum(PROPDMG))
  
financial_data <- financial_data %>%
  group_by(EVTYPE) %>%
  summarise(totalcropdmg=sum(totalcropdmg), totalpropdmg=sum(totalpropdmg)) %>%
  mutate(totaldmg=totalcropdmg+totalpropdmg) %>%
  top_n(n = 6, wt=totaldmg)

```

Plot a graphic of the economic consequences.
```{r echot=TRUE}
library(ggplot2)
financial_plot <- ggplot(financial_data, aes(EVTYPE))
financial_plot +  geom_bar(aes(y=totalpropdmg), color="darkgreen", fill="green", alpha=0.4, stat="identity") + 
  geom_bar(aes(y = totalcropdmg), colour = "darkred", fill="red", alpha=0.4, stat = "identity") +
  ggtitle("6 top most financial eavy events") + ylab("dommage in dollars") + xlab("Events")
```

## Results

You can also embed plots, for example:

```{r pressure, echo=TRUE}
#library("ggplot2")
#stepsPerDayPlot <- ggplot(data = financial_data, aes(EVTYPE,PROPDMG+CROPDMG))
#  stepsPerDayPlot + geom_histogram(binwidth = 5000,colour="darkgreen", fill="lightgreen",alpha=0.4) +
#                    ggtitle("Distribution of steps per day") + ylab("Frequency") + xlab("Total steps")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
